<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WiFi SSID Mapper</title>

  <!-- Bootstrap 5 CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet"/>

  <!-- DataTables + Bootstrap styling -->
  <link 
    href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" 
    rel="stylesheet"/>

  <style>
    .ssid-editable:hover {
      cursor: pointer;
      background-color: #eef;
    }
    .ssid-mapped {
      background-color: #fff8e1;
      font-style: italic;
    }
    .ssid-mapped::after {
      content: " ‚≠ê";
    }
    /* Highlight full row for user-added entries */
    .table-info { }
  </style>
</head>
<body class="bg-light">
  <div class="container-fluid py-4">
    <h1 class="mb-4">WiFi SSID Mapper</h1>

    <!-- Auto-refresh and Rescan controls -->
    <div class="d-flex align-items-center mb-3">
      <div class="form-check me-4">
        <input class="form-check-input" type="checkbox" id="auto-refresh">
        <label class="form-check-label" for="auto-refresh">Auto-Refresh</label>
      </div>
      <div class="input-group me-3" style="width:120px;">
        <span class="input-group-text">Interval (s)</span>
        <input type="number" id="refresh-interval" class="form-control" value="5" min="1">
      </div>
      <button id="rescan-btn" class="btn btn-secondary">Rescan Now</button>
    </div>

    <!-- Wi-Fi table -->
    <div class="table-responsive">
      <table id="wifi-table"
             class="table table-bordered table-hover w-100"
             style="min-width:800px">
        <thead><tr></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- SSID Entry Modal -->
  <div class="modal fade" id="ssidModal" tabindex="-1" aria-labelledby="ssidModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="ssid-form" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ssidModalLabel">Enter Friendly SSID</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="modal-mac">
          <div class="mb-3">
            <label for="modal-ssid" class="form-label">SSID for MAC <span id="modal-mac-label"></span></label>
            <input type="text" class="form-control" id="modal-ssid" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save SSID</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script 
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
  </script>
  <script 
    src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js">
  </script>
  <script 
    src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js">
  </script>

  <script>
  // Server-injected data
  const columns     = {{ columns|tojson }};
  const initialData = {{ networks|tojson }};
  const rssiIndex   = {{ rssi_index }};

  let table, refreshTimer, ssidModal;

  // Initialize DataTable
  function initTable(data) {
    const colDefs = columns.map(colName => ({
      title: colName,
      data:  null,
      render: (row) => row[colName]
    }));

    if (table) {
      table.clear().rows.add(data).draw();
      return;
    }
    table = $('#wifi-table').DataTable({
      data:       data,
      columns:    colDefs,
      pageLength: -1,
      lengthMenu: [[-1,10,25,50], ['All',10,25,50]],
      order:      [[ rssiIndex, 'desc' ]],
      createdRow: (rowElem, rowData) => {
        if (rowData.__mapped) $(rowElem).addClass('table-info');
        if (rowData.__hidden) {
          const idx = columns.indexOf('SSID');
          const $cell = $('td', rowElem).eq(idx);
          $cell.addClass('ssid-editable');
          if (rowData.__mapped) $cell.addClass('ssid-mapped');
          $cell.attr('data-mac', rowData.__mac);
        }
      }
    });
  }

  // Fetch new data and update table
  function fetchAndUpdate() {
    $.getJSON('/api/networks', resp => {
      initTable(resp.networks);
    });
  }

  $(document).ready(() => {
    // 1) Build table with initial data
    initTable(initialData);

    // 2) Setup Bootstrap modal instance
    const modalEl = document.getElementById('ssidModal');
    ssidModal = new bootstrap.Modal(modalEl);

    // 3) Double-click handler: show modal
    $('#wifi-table').on('dblclick', '.ssid-editable', function(){
      const mac     = $(this).data('mac');
      const current = $(this).text().trim();
      $('#modal-mac').val(mac);
      $('#modal-mac-label').text(mac);
      $('#modal-ssid').val(current);
      ssidModal.show();
    });

    // 4) Modal form submission
    $('#ssid-form').on('submit', function(e){
      e.preventDefault();
      const mac  = $('#modal-mac').val();
      const name = $('#modal-ssid').val().trim();
      if (!name) return;
      $.ajax({
        url: '/update_mapping',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ mac, name }),
        success: () => {
          ssidModal.hide();
          fetchAndUpdate();
        },
        error: xhr => alert('Error: ' + xhr.responseText)
      });
    });

    // 5) Manual rescan
    $('#rescan-btn').click(fetchAndUpdate);

    // 6) Auto-refresh toggle
    $('#auto-refresh').change(function(){
      if (this.checked) {
        const sec = Math.max(1, parseInt($('#refresh-interval').val(),10) || 5);
        refreshTimer = setInterval(fetchAndUpdate, sec*1000);
      } else {
        clearInterval(refreshTimer);
      }
    });
  });
  </script>
</body>
</html>
